---
import Layout from "../layouts/Layout.astro";
import { Header } from "../components/layout/Header";
import { Footer } from "../components/layout/Footer";
import { AnimatedSearch } from "../components/search/AnimatedSearch";
import { ScenarioGrid } from "../components/home/ScenarioGrid";
import { loadAllTargets, getStats } from "../lib/kapefiles";

const stats = getStats();
const allTargets = loadAllTargets();

// LOLBin count
const lolbinSlugs = new Set([
    "bits",
    "certutil",
    "powershellconsole",
    "powershelltranscripts",
    "powershell7config",
    "wbem",
    "scheduledtasks",
    "mof",
]);
const lolbinCount = allTargets.filter((t) =>
    lolbinSlugs.has(t.slug.toLowerCase()),
).length;

// Investigation scenarios with artifact mappings
const scenarios = [
    {
        id: "lateral-movement",
        title: "Lateral Movement",
        description: "Track attacker movement across network",
        artifacts: [
            "rdpcache",
            "eventlogs-rdp",
            "eventlogs",
            "psexec",
            "bits",
            "smbclient",
            "networkprofiles",
        ],
        keywords: ["RDP", "PSExec", "WinRM", "Event Logs", "Network"],
        color: "cyan" as const,
    },
    {
        id: "browser-forensics",
        title: "Browser Forensics",
        description: "Analyze web activity and downloads",
        artifacts: [
            "chrome",
            "firefox",
            "edge",
            "ienetcache",
            "browsercache",
            "chromiumextensions",
        ],
        keywords: ["Chrome", "Firefox", "Edge", "History", "Downloads"],
        color: "blue" as const,
    },
    {
        id: "persistence",
        title: "Persistence",
        description: "Find malware survival mechanisms",
        artifacts: [
            "scheduledtasks",
            "registryhivesuser",
            "registryhivessystem",
            "startupfolders",
            "services",
            "wbem",
            "mof",
        ],
        keywords: ["Run Keys", "Services", "Tasks", "Startup", "WMI"],
        color: "red" as const,
    },
    {
        id: "execution",
        title: "Program Execution",
        description: "Evidence of program execution",
        artifacts: [
            "prefetch",
            "amcache",
            "shimcache",
            "srum",
            "appcompatpca",
            "userassist",
            "bam",
        ],
        keywords: ["Prefetch", "Amcache", "ShimCache", "SRUM", "BAM"],
        color: "green" as const,
    },
    {
        id: "user-activity",
        title: "User Activity",
        description: "Reconstruct user behavior timeline",
        artifacts: [
            "shellbags",
            "recentfilecache",
            "jumplists",
            "lnkfiles",
            "thumbcache",
            "wordwheelquery",
        ],
        keywords: ["Shellbags", "Recent", "Jump Lists", "LNK", "MRU"],
        color: "purple" as const,
    },
    {
        id: "anti-forensics",
        title: "Data Recovery",
        description: "Recover deleted and hidden data",
        artifacts: [
            "$mft",
            "$j",
            "$logfile",
            "recyclebin",
            "$usnjrnl",
            "vss",
            "thumbcache",
        ],
        keywords: ["$MFT", "$J", "USN Journal", "Recycle Bin", "VSS"],
        color: "amber" as const,
    },
];

// Count matching artifacts for each scenario
const scenariosWithCounts = scenarios.map((scenario) => {
    const count = allTargets.filter((t) =>
        scenario.artifacts.some((a) =>
            t.slug.toLowerCase().includes(a.toLowerCase()),
        ),
    ).length;
    return {
        id: scenario.id,
        title: scenario.title,
        description: scenario.description,
        keywords: scenario.keywords,
        color: scenario.color,
        count: Math.max(count, scenario.artifacts.length),
    };
});

// Expanded popular artifacts for marquee - get more artifacts
const popularSlugsRow1 = [
    "prefetch",
    "amcache",
    "eventlogs",
    "registryhivesuser",
    "chrome",
    "srum",
    "shimcache",
    "firefox",
    "edge",
    "scheduledtasks",
    "mft",
    "usnjrnl",
];
const popularSlugsRow2 = [
    "jumplists",
    "lnkfiles",
    "shellbags",
    "recyclebin",
    "bits",
    "rdpcache",
    "windowstimeline",
    "thumbcache",
    "userassist",
    "bam",
    "anydesk",
    "teamviewer",
];

const popularArtifactsRow1 = popularSlugsRow1
    .map((slug) =>
        allTargets.find((t) => t.slug.toLowerCase() === slug.toLowerCase()),
    )
    .filter(Boolean);

const popularArtifactsRow2 = popularSlugsRow2
    .map((slug) =>
        allTargets.find((t) => t.slug.toLowerCase() === slug.toLowerCase()),
    )
    .filter(Boolean);

// Category pills for quick filtering (links to /artefacts with filter)
const categories = [
    { id: "all", label: "All", count: stats.total },
    { id: "lolbin", label: "LOLBins", count: lolbinCount, special: true },
    { id: "windows", label: "Windows", count: stats.byCategory.Windows || 0 },
    {
        id: "browsers",
        label: "Browsers",
        count: stats.byCategory.Browsers || 0,
    },
    { id: "apps", label: "Apps", count: stats.byCategory.Apps || 0 },
    {
        id: "antivirus",
        label: "Antivirus",
        count: stats.byCategory.Antivirus || 0,
    },
];
---

<Layout title="DFIRHub">
    <div class="min-h-screen bg-background relative">
        <!-- Radial Gradient Background -->
        <div
            class="absolute inset-0 z-0 pointer-events-none"
            aria-hidden="true"
            style="background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(16, 185, 129, 0.04), transparent);"
        >
        </div>

        <Header client:load showSearch={false} />

        <main class="mx-auto max-w-6xl px-4">
            <!-- Hero -->
            <div class="text-center py-16 border-b border-border/30">
                <h1 class="text-3xl font-semibold mb-3">
                    Find DFIR artifacts <span class="text-primary">fast</span>
                </h1>
                <p class="text-muted-foreground mb-8">
                    Search {stats.total} Windows forensic artifacts, paths, and collection
                    targets
                </p>

                <!-- Search -->
                <div class="max-w-lg mx-auto mb-8">
                    <AnimatedSearch client:load />
                </div>

                <!-- Category Pills -->
                <div class="flex flex-wrap justify-center gap-2">
                    {
                        categories.map((cat) => {
                            const href =
                                cat.id === "all"
                                    ? "/artefacts"
                                    : "/artefacts?filter=" + cat.id;
                            const baseClass =
                                "px-4 py-2 text-sm rounded-full border transition-all";
                            const colorClass = cat.special
                                ? "text-primary border-primary/30 hover:border-primary hover:bg-primary/10"
                                : "text-muted-foreground border-border hover:border-foreground hover:text-foreground";
                            return (
                                <a
                                    href={href}
                                    class={baseClass + " " + colorClass}
                                >
                                    {cat.label}
                                    <span class="ml-1 opacity-60">
                                        {cat.count}
                                    </span>
                                </a>
                            );
                        })
                    }
                </div>
            </div>

            <!-- Investigate by Scenario -->
            <section class="py-12 border-b border-border/30">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-sm text-muted-foreground">
                        <span class="text-primary">//</span> INVESTIGATE BY SCENARIO
                    </h2>
                </div>

                <ScenarioGrid client:load scenarios={scenariosWithCounts} />
            </section>

            <!-- Popular Artifacts - Marquee -->
            <section class="py-12">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-sm text-muted-foreground">
                        <span class="text-primary">//</span> POPULAR ARTIFACTS
                    </h2>
                    <a
                        href="/artefacts"
                        class="text-xs text-primary hover:text-primary/80 transition-colors"
                    >
                        view all →
                    </a>
                </div>

                <!-- Marquee Container -->
                <div class="relative overflow-hidden">
                    <!-- Fade edges -->
                    <div
                        class="pointer-events-none absolute left-0 top-0 bottom-0 w-16 bg-gradient-to-r from-background to-transparent z-10"
                    >
                    </div>
                    <div
                        class="pointer-events-none absolute right-0 top-0 bottom-0 w-16 bg-gradient-to-l from-background to-transparent z-10"
                    >
                    </div>

                    <!-- Row 1 - scrolls left -->
                    <div class="marquee-row mb-3">
                        <div class="marquee-content animate-marquee">
                            {
                                [
                                    ...popularArtifactsRow1,
                                    ...popularArtifactsRow1,
                                ].map((artifact) => {
                                    if (!artifact) return null;
                                    const href = "/artefact/" + artifact.slug;
                                    const pathCount = artifact.isCompound
                                        ? artifact.referencedTargets.length +
                                          " targets"
                                        : artifact.targets.filter(
                                              (e) => !e.path.endsWith(".tkape"),
                                          ).length + " paths";
                                    return (
                                        <a
                                            href={href}
                                            class="marquee-item group flex-shrink-0 w-56 p-4 border border-border/50 rounded-xl hover:border-primary/50 hover:bg-card/50 transition-all"
                                        >
                                            <h3 class="font-medium text-sm mb-1 group-hover:text-primary transition-colors truncate">
                                                {artifact.name}
                                            </h3>
                                            <p class="text-xs text-muted-foreground mb-2 truncate">
                                                {artifact.description ||
                                                    "Forensic artifact"}
                                            </p>
                                            <div class="flex items-center gap-2 text-[10px]">
                                                <span class="text-muted-foreground/50 uppercase">
                                                    {artifact.category}
                                                </span>
                                                <span class="text-muted-foreground/30">
                                                    ·
                                                </span>
                                                <span class="text-muted-foreground/50">
                                                    {pathCount}
                                                </span>
                                            </div>
                                        </a>
                                    );
                                })
                            }
                        </div>
                    </div>

                    <!-- Row 2 - scrolls right -->
                    <div class="marquee-row">
                        <div class="marquee-content animate-marquee-reverse">
                            {
                                [
                                    ...popularArtifactsRow2,
                                    ...popularArtifactsRow2,
                                ].map((artifact) => {
                                    if (!artifact) return null;
                                    const href = "/artefact/" + artifact.slug;
                                    const pathCount = artifact.isCompound
                                        ? artifact.referencedTargets.length +
                                          " targets"
                                        : artifact.targets.filter(
                                              (e) => !e.path.endsWith(".tkape"),
                                          ).length + " paths";
                                    return (
                                        <a
                                            href={href}
                                            class="marquee-item group flex-shrink-0 w-56 p-4 border border-border/50 rounded-xl hover:border-primary/50 hover:bg-card/50 transition-all"
                                        >
                                            <h3 class="font-medium text-sm mb-1 group-hover:text-primary transition-colors truncate">
                                                {artifact.name}
                                            </h3>
                                            <p class="text-xs text-muted-foreground mb-2 truncate">
                                                {artifact.description ||
                                                    "Forensic artifact"}
                                            </p>
                                            <div class="flex items-center gap-2 text-[10px]">
                                                <span class="text-muted-foreground/50 uppercase">
                                                    {artifact.category}
                                                </span>
                                                <span class="text-muted-foreground/30">
                                                    ·
                                                </span>
                                                <span class="text-muted-foreground/50">
                                                    {pathCount}
                                                </span>
                                            </div>
                                        </a>
                                    );
                                })
                            }
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <Footer client:load />
    </div>
</Layout>

<style>
    @keyframes blink {
        0%,
        50% {
            opacity: 1;
        }
        51%,
        100% {
            opacity: 0;
        }
    }
    :global(.animate-blink) {
        animation: blink 1s infinite;
    }

    /* Marquee styles */
    .marquee-row {
        display: flex;
        overflow: hidden;
    }

    .marquee-content {
        display: flex;
        gap: 0.75rem;
    }

    .marquee-item {
        flex-shrink: 0;
    }

    @keyframes marquee {
        0% {
            transform: translateX(0);
        }
        100% {
            transform: translateX(-50%);
        }
    }

    @keyframes marquee-reverse {
        0% {
            transform: translateX(-50%);
        }
        100% {
            transform: translateX(0);
        }
    }

    .animate-marquee {
        animation: marquee 40s linear infinite;
    }

    .animate-marquee-reverse {
        animation: marquee-reverse 40s linear infinite;
    }

    /* Pause on hover */
    .marquee-row:hover .marquee-content {
        animation-play-state: paused;
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
        .animate-marquee,
        .animate-marquee-reverse {
            animation: none;
        }
        .marquee-content {
            flex-wrap: wrap;
            justify-content: center;
        }
        .marquee-row {
            overflow: visible;
        }
    }
</style>
