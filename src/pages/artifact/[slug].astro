---
import {
  ArtifactBreadcrumb,
  ArtifactCard,
  ArtifactFooter,
  ArtifactHeader,
  ArtifactList,
  ArtifactListItem,
  ArtifactPageContainer,
  ArtifactSection,
} from "../../components/artifact/ArtifactContent";
import { CategoryChip } from "../../components/artifact/CategoryChip";
import { CommandGenerator } from "../../components/artifact/CommandGenerator";
import { CyberChefLinks } from "../../components/artifact/CyberChefLinks";
import { PathBrowser } from "../../components/artifact/PathBrowser";
import Footer from "../../components/layout/Footer.astro";
import { Header } from "../../components/layout/Header";
import Layout from "../../layouts/Layout.astro";
import {
  findCollectionsContaining,
  type KapeTarget,
  loadAllTargets,
  resolveCompoundReferences,
} from "../../lib/kapefiles";

export async function getStaticPaths() {
  const targets = loadAllTargets();
  return targets.map((target) => ({
    params: { slug: target.slug },
    props: { target },
  }));
}

interface Props {
  target: KapeTarget;
}

const { target } = Astro.props;

// Resolve compound targets to their individual targets
const resolvedTargets = target.isCompound
  ? resolveCompoundReferences(target)
  : undefined;

// Find collections that include this target
const includedInCollections = findCollectionsContaining(target.slug);

// SEO description with context
const pathCount = target.isCompound
  ? `${target.referencedTargets.length} targets`
  : `${target.targets.filter((e) => !e.path.endsWith(".tkape")).length} paths`;
const seoDescription = target.description
  ? target.description +
    " KAPE target with " +
    pathCount +
    " for Windows forensic collection."
  : target.name +
    " - Windows forensic artifact with " +
    pathCount +
    ". KAPE collection target for DFIR investigations.";

// JSON-LD for artifact page
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "TechArticle",
  headline: `${target.name} - Windows Forensic Artifact`,
  description: seoDescription,
  author: {
    "@type": "Person",
    name: target.author,
  },
  publisher: {
    "@type": "Organization",
    name: "DFIRHub",
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `https://dfirhub.com/artifact/${target.slug}`,
  },
  about: {
    "@type": "Thing",
    name: "Digital Forensics",
    description: "Windows forensic artifact for incident response",
  },
  keywords: [
    "DFIR",
    "forensics",
    target.name,
    target.category,
    "KAPE",
    "Windows forensics",
  ].join(", "),
};
---

<Layout title={target.name} description={seoDescription}>
  <!-- Artifact-specific JSON-LD -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify(jsonLd)}
    slot="head"
  />

  <Header client:load />

  <main id="main-content" class="flex-1 relative" tabindex="-1">
    <div class="mx-auto max-w-6xl px-4 py-8">
      <ArtifactPageContainer client:load>
        <!-- Breadcrumb Navigation -->
        <ArtifactBreadcrumb className="mb-6 text-xs text-muted-foreground">
          <ol class="flex items-center flex-wrap gap-1" role="list">
            <li>
              <a
                href="/"
                class="hover:text-foreground transition-colors focus-ring rounded-sm px-1"
              >
                <span class="text-primary">~</span>/
              </a>
            </li>
            <li class="flex items-center gap-1">
              <span aria-hidden="true">/</span>
              <a
                href="/artifacts"
                class="hover:text-foreground transition-colors focus-ring rounded-sm px-1"
                >artifacts</a
              >
            </li>
            <li class="flex items-center gap-1">
              <span aria-hidden="true">/</span>
              <a
                href={"/artifacts?category=" +
                                    target.category.toLowerCase()}
                class="hover:text-foreground transition-colors focus-ring rounded-sm px-1"
              >
                {target.category.toLowerCase()}
              </a>
            </li>
            <li class="flex items-center gap-1">
              <span aria-hidden="true">/</span>
              <span class="text-foreground px-1" aria-current="page"
                >{target.slug}</span
              >
            </li>
          </ol>
        </ArtifactBreadcrumb>

        <!-- Header -->
        <ArtifactHeader className="mb-8">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between sm:gap-4">
            <div class="min-w-0">
              <h1 class="text-2xl font-semibold mb-3" id="artifact-title">
                {target.name}
              </h1>
              <CategoryChip
                client:load
                category={target.category}
                version={target.version}
                isCompound={target.isCompound}
              />
            </div>
            <div class="text-xs text-muted-foreground sm:text-right sm:shrink-0 sm:max-w-[50%]">
              <p class="break-words">
                Author: <span class="text-foreground">{target.author}</span>
              </p>
            </div>
          </div>
        </ArtifactHeader>

        <!-- Description -->
        {target.description && (
                        <ArtifactCard
                            className="mb-8 p-5 glass-subtle rounded-xl"
                        >
                            <h2
                                id="description-heading"
                                class="text-xs uppercase tracking-wider text-muted-foreground mb-3 flex items-center gap-2"
                            >
                                <span
                                    class="text-primary/50"
                                    aria-hidden="true"
                                >
                                    //
                                </span>
                                description
                            </h2>
                            <p class="text-sm leading-relaxed whitespace-pre-line">
                                {target.description}
                            </p>
                        </ArtifactCard>
                    )}

        <!-- Compound Target Info -->
        {target.isCompound && resolvedTargets && (
                        <ArtifactSection
                            className="mb-8"
                            ariaLabel="includes-heading"
                        >
                            <h2
                                id="includes-heading"
                                class="text-xs uppercase tracking-wider text-muted-foreground mb-3 flex items-center gap-2"
                            >
                                <span
                                    class="text-primary/50"
                                    aria-hidden="true"
                                >
                                    //
                                </span>
                                includes
                                <span class="text-primary">
                                    ({resolvedTargets.length})
                                </span>
                            </h2>
                            <ArtifactList className="glass-subtle rounded-xl divide-y divide-white/[0.04]">
                                {target.referencedTargets
                                    .slice(0, 20)
                                    .map((ref) => {
                                        const refName = ref.replace(
                                            /\.tkape$/,
                                            "",
                                        );
                                        const foundTarget =
                                            resolvedTargets.find(
                                                (t) =>
                                                    t.sourceFile
                                                        .replace(/\.tkape$/, "")
                                                        .toLowerCase() ===
                                                    refName.toLowerCase(),
                                            );
                                        return (
                                            <ArtifactListItem>
                                                <a
                                                    href={
                                                        foundTarget
                                                            ? "/artifact/" +
                                                              foundTarget.slug
                                                            : "#"
                                                    }
                                                    class="flex items-center justify-between px-4 py-2 hover:bg-primary/5 transition-colors group"
                                                >
                                                    <span class="text-sm">
                                                        {refName}
                                                    </span>
                                                    {foundTarget && (
                                                        <span class="text-xs text-muted-foreground group-hover:text-primary transition-colors">
                                                            {
                                                                foundTarget.targets.filter(
                                                                    (e) =>
                                                                        !e.path.endsWith(
                                                                            ".tkape",
                                                                        ),
                                                                ).length
                                                            }{" "}
                                                            paths →
                                                        </span>
                                                    )}
                                                </a>
                                            </ArtifactListItem>
                                        );
                                    })}
                                {target.referencedTargets.length > 20 && (
                                    <ArtifactListItem>
                                        <div class="px-4 py-2 text-xs text-muted-foreground">
                                            +
                                            {target.referencedTargets.length -
                                                20}{" "}
                                            more targets
                                        </div>
                                    </ArtifactListItem>
                                )}
                            </ArtifactList>
                        </ArtifactSection>
                    )}

        <!-- Paths -->
        <ArtifactSection className="mb-8" ariaLabel="paths-heading">
          <h2
            id="paths-heading"
            class="text-xs uppercase tracking-wider text-muted-foreground mb-3 flex items-center gap-2"
          >
            <span class="text-primary/50" aria-hidden="true">//</span>
            paths
          </h2>
          <PathBrowser
            client:idle
            target={target}
            resolvedTargets={resolvedTargets}
          />
        </ArtifactSection>

        <!-- Tool Commands -->
        <ArtifactSection className="mb-8" ariaLabel="commands-heading">
          <h2
            id="commands-heading"
            class="text-xs uppercase tracking-wider text-muted-foreground mb-3 flex items-center gap-2"
          >
            <span class="text-primary/50" aria-hidden="true">//</span>
            collection commands
          </h2>
          <CommandGenerator client:idle target={target} />
        </ArtifactSection>

        <!-- CyberChef Links -->
        <ArtifactSection className="mb-8">
          <CyberChefLinks client:idle target={target} />
        </ArtifactSection>

        <!-- Documentation / References -->
        {target.documentation.length > 0 && (
                        <ArtifactSection
                            className="mb-8"
                            ariaLabel="references-heading"
                        >
                            <h2
                                id="references-heading"
                                class="text-xs uppercase tracking-wider text-muted-foreground mb-3 flex items-center gap-2"
                            >
                                <span
                                    class="text-primary/50"
                                    aria-hidden="true"
                                >
                                    //
                                </span>
                                references
                            </h2>
                            <ArtifactList className="space-y-2">
                                {target.documentation.map((url) => (
                                    <ArtifactListItem>
                                        <a
                                            href={url}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            class="group flex items-center gap-2 text-xs text-primary hover:text-primary/80 transition-colors focus-ring rounded-sm py-1"
                                        >
                                            <span
                                                class="text-muted-foreground group-hover:text-primary transition-colors"
                                                aria-hidden="true"
                                            >
                                                →
                                            </span>
                                            <span class="truncate">{url}</span>
                                            <span class="sr-only">
                                                (opens in new tab)
                                            </span>
                                        </a>
                                    </ArtifactListItem>
                                ))}
                            </ArtifactList>
                        </ArtifactSection>
                    )}

        <!-- Included In Collections -->
        {includedInCollections.length > 0 && (
                        <ArtifactSection
                            className="mb-8"
                            ariaLabel="collections-heading"
                        >
                            <h2
                                id="collections-heading"
                                class="text-xs uppercase tracking-wider text-muted-foreground mb-3 flex items-center gap-2"
                            >
                                <span
                                    class="text-primary/50"
                                    aria-hidden="true"
                                >
                                    //
                                </span>
                                included in collections
                            </h2>
                            <div class="flex flex-wrap gap-2" role="list">
                                {includedInCollections.map((collection) => (
                                    <a
                                        href={"/artifact/" + collection.slug}
                                        class="px-3 py-1.5 text-xs text-cyan-400 border border-cyan-500/30 bg-cyan-500/10 hover:bg-cyan-500/20 transition-colors focus-ring rounded-md"
                                        role="listitem"
                                    >
                                        {collection.name}
                                    </a>
                                ))}
                            </div>
                        </ArtifactSection>
                    )}

        <!-- Source File -->
        <ArtifactFooter
          className="text-xs text-muted-foreground/50 pt-4 border-t border-border/30"
        >
          <span>source: </span>
          <a
            href={"https://github.com/EricZimmerman/KapeFiles/blob/master/Targets/" +
                            target.category +
                            "/" +
                            target.sourceFile}
            target="_blank"
            rel="noopener noreferrer"
            class="text-primary/50 hover:text-primary transition-colors focus-ring rounded-sm"
          >
            KapeFiles/{target.category}/{target.sourceFile}
            <span class="sr-only">(opens in new tab)</span>
          </a>
        </ArtifactFooter>
      </ArtifactPageContainer>
    </div>
  </main>

  <Footer />
</Layout>
