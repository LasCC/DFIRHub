---
import { CategoryFilters } from "../components/artifacts/CategoryFilters";
import Footer from "../components/layout/Footer.astro";
import { Header } from "../components/layout/Header";
import Layout from "../layouts/Layout.astro";
import { getCategories, getStats, loadAllTargets } from '../lib/kapefiles';
import type { KapeTarget } from '../lib/kapefiles';

const targets = loadAllTargets();
const categories = getCategories();
const stats = getStats();

// Scenario artifact mappings
const scenarioArtifacts: Record<string, string[]> = {
  "anti-forensics": [
    "$mft",
    "$j",
    "$logfile",
    "recyclebin",
    "$usnjrnl",
    "vss",
    "thumbcache",
    "usn",
  ],
  "browser-forensics": [
    "chrome",
    "firefox",
    "edge",
    "ienetcache",
    "browsercache",
    "chromiumextensions",
    "browser",
  ],
  execution: [
    "prefetch",
    "amcache",
    "shimcache",
    "srum",
    "appcompatpca",
    "userassist",
    "bam",
  ],
  "lateral-movement": [
    "rdpcache",
    "eventlogs-rdp",
    "eventlogs",
    "psexec",
    "bits",
    "smbclient",
    "networkprofiles",
    "rdp",
  ],
  persistence: [
    "scheduledtasks",
    "registryhivesuser",
    "registryhivessystem",
    "startupfolders",
    "services",
    "wbem",
    "mof",
    "registry",
  ],
  "user-activity": [
    "shellbags",
    "recentfilecache",
    "jumplists",
    "lnkfiles",
    "thumbcache",
    "wordwheelquery",
    "recent",
    "mru",
  ],
};

// Group targets by category
const targetsByCategory = categories.reduce(
  (acc, cat) => {
    acc[cat] = targets.filter((t) => t.category === cat);
    return acc;
  },
  {} as Record<string, KapeTarget[]>
);

// Category color and accent configuration
const categoryStyles: Record<
  string,
  { accent: string; text: string; bg: string }
> = {
  Antivirus: {
    accent: "bg-red-500",
    bg: "bg-red-500/5",
    text: "text-red-400",
  },
  Apps: {
    accent: "bg-emerald-500",
    bg: "bg-emerald-500/5",
    text: "text-emerald-400",
  },
  Browsers: {
    accent: "bg-orange-500",
    bg: "bg-orange-500/5",
    text: "text-orange-400",
  },
  Compound: {
    accent: "bg-cyan-500",
    bg: "bg-cyan-500/5",
    text: "text-cyan-400",
  },
  Logs: {
    accent: "bg-yellow-500",
    bg: "bg-yellow-500/5",
    text: "text-yellow-400",
  },
  P2P: {
    accent: "bg-purple-500",
    bg: "bg-purple-500/5",
    text: "text-purple-400",
  },
  Windows: {
    accent: "bg-blue-500",
    bg: "bg-blue-500/5",
    text: "text-blue-400",
  },
};

function getStyle(category: string) {
  return (
    categoryStyles[category] || {
      accent: "bg-zinc-500",
      bg: "bg-zinc-500/5",
      text: "text-zinc-400",
    }
  );
}

// Serialize data for client-side filtering
const allTargetsJson = JSON.stringify(
  targets.map((t) => ({
    category: t.category,
    isCompound: t.isCompound,
    name: t.name,
    slug: t.slug,
  }))
);
const scenarioArtifactsJson = JSON.stringify(scenarioArtifacts);

// Build filter categories for CategoryFilters component
const filterCategories = [
  { count: stats.total, id: "all", label: "All" },
  ...categories.map((cat) => ({
    count: stats.byCategory[cat] || 0,
    id: cat.toLowerCase(),
    label: cat,
  })),
];
---

<Layout
  title="All Artifacts"
  description="Browse all KAPE forensic artifact targets"
>
  <Header client:load />

  <main id="main-content" class="flex-1 relative" tabindex="-1">
    <div class="mx-auto max-w-6xl px-4 py-8">
      <!-- Breadcrumb -->
      <nav class="mb-6 text-xs text-muted-foreground" aria-label="Breadcrumb">
        <ol class="flex items-center gap-1">
          <li>
            <a
              href="/"
              class="hover:text-foreground transition-colors focus-ring rounded-sm px-1"
            >
              <span class="text-primary">~</span>/
            </a>
          </li>
          <li class="flex items-center gap-1">
            <span aria-hidden="true">/</span>
            <span class="text-foreground px-1" aria-current="page"
              >artifacts</span
            >
          </li>
        </ol>
      </nav>

      <!-- Header -->
      <header class="mb-8">
        <h1 class="text-3xl font-semibold mb-2 tracking-tight">
          All Artifacts
        </h1>
        <p class="text-sm text-muted-foreground">
          Browse <span class="text-primary font-mono">{stats.total}</span> KAPE
          forensic artifact targets
        </p>
      </header>

      <!-- Active Filter Banner (hidden by default, shown via JS) -->
      <div id="filter-banner" class="hidden mb-6 p-3 sm:p-4 rounded-xl glass-subtle">
        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-1.5 sm:gap-3 min-w-0">
            <span class="text-xs sm:text-sm text-muted-foreground shrink-0">Filtered by:</span>
            <span
              id="filter-label"
              class="text-xs sm:text-sm font-semibold text-primary truncate"
            ></span>
            <span
              id="filter-count"
              class="text-[10px] sm:text-xs text-muted-foreground font-mono shrink-0"
            ></span>
          </div>
          <a
            href="/artifacts"
            class="text-xs text-zinc-400 hover:text-white transition-colors flex items-center gap-1 shrink-0"
          >
            clear filter
            <svg
              class="w-3 h-3"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </a>
        </div>
      </div>

      <!-- Category Filter (sticky below header) -->
      <div class="sticky top-14 z-40 -mx-4 px-4 py-3 bg-[#09090b]/80 backdrop-blur-md border-b border-white/[0.04] mb-8">
        <CategoryFilters client:idle categories={filterCategories} />
      </div>

      <!-- Default View: Targets by Category (hidden when filtered) -->
      <div id="default-view">
        {categories.map((category) => {
                        const style = getStyle(category);
                        return (
                            <section
                                class="category-section mb-12"
                                data-category={category.toLowerCase()}
                                aria-labelledby={"category-" + category.toLowerCase()}
                            >
                                <div class="flex items-center justify-between mb-5">
                                    <h2
                                        id={"category-" + category.toLowerCase()}
                                        class="text-sm font-medium flex items-center gap-3"
                                    >
                                        <span class={`w-2 h-2 rounded-full ${style.accent}`}></span>
                                        <span class="text-foreground">{category}</span>
                                        <span class={`text-xs font-mono ${style.text}`}>
                                            {targetsByCategory[category].length}
                                        </span>
                                    </h2>
                                    <a
                                        href={"/artifacts?category=" + category.toLowerCase()}
                                        class="text-xs text-muted-foreground hover:text-primary transition-colors focus-ring rounded-sm px-2 py-1 flex items-center gap-1"
                                    >
                                        view all
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </a>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                    {targetsByCategory[category]
                                        .slice(0, 6)
                                        .map((target) => (
                                            <a
                                                href={"/artifact/" + target.slug}
                                                class={`artifact-card group rounded-xl border border-white/[0.06] bg-white/[0.02] backdrop-blur-sm transition-all duration-300 hover:border-white/[0.12] hover:bg-white/[0.05]`}
                                            >
                                                <div class="p-4">
                                                    <div class="flex items-start justify-between gap-2 mb-2">
                                                        <h3 class="text-sm font-medium text-zinc-200 group-hover:text-white transition-colors truncate">
                                                            {target.name}
                                                        </h3>
                                                        {target.isCompound && (
                                                            <span class="shrink-0 px-2 py-0.5 text-[9px] uppercase tracking-wider font-medium text-cyan-400 bg-cyan-500/10 border border-cyan-500/20 rounded-full">
                                                                collection
                                                            </span>
                                                        )}
                                                    </div>
                                                    <p class="text-xs text-zinc-500 line-clamp-2 mb-3 leading-relaxed">
                                                        {target.description || "No description available"}
                                                    </p>
                                                    <div class="flex items-center justify-between text-[10px]">
                                                        <span class={`uppercase tracking-wider font-medium ${style.text}`}>
                                                            {target.category}
                                                        </span>
                                                        <span class="text-zinc-600 font-mono">
                                                            {!target.isCompound
                                                                ? target.targets.filter((e) => !e.path.endsWith(".tkape")).length + " paths"
                                                                : target.referencedTargets.length + " targets"}
                                                        </span>
                                                    </div>
                                                </div>
                                            </a>
                                        ))}
                                </div>
                                {targetsByCategory[category].length > 6 && (
                                    <div class="mt-4 text-center">
                                        <a
                                            href={"/artifacts?category=" + category.toLowerCase()}
                                            class="inline-flex items-center gap-2 text-xs text-zinc-500 hover:text-zinc-300 transition-colors px-4 py-2 rounded-full border border-white/[0.04] hover:border-white/[0.08] hover:bg-white/[0.02]"
                                        >
                                            <span>+{targetsByCategory[category].length - 6} more in {category}</span>
                                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                            </svg>
                                        </a>
                                    </div>
                                )}
                            </section>
                        );
                    })}
      </div>

      <!-- Filtered View: All matching artifacts (hidden by default) -->
      <div id="filtered-view" class="hidden">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {targets.map((target) => {
                            const style = getStyle(target.category);
                            return (
                                <a
                                    href={"/artifact/" + target.slug}
                                    data-slug={target.slug.toLowerCase()}
                                    data-category={target.category.toLowerCase()}
                                    class={`filtered-card artifact-card group rounded-xl border border-white/[0.06] bg-white/[0.02] backdrop-blur-sm transition-all duration-300 hover:border-white/[0.12] hover:bg-white/[0.05]`}
                                >
                                    <div class="p-4">
                                        <div class="flex items-start justify-between gap-2 mb-2">
                                            <h3 class="text-sm font-medium text-zinc-200 group-hover:text-white transition-colors truncate">
                                                {target.name}
                                            </h3>
                                            {target.isCompound && (
                                                <span class="shrink-0 px-2 py-0.5 text-[9px] uppercase tracking-wider font-medium text-cyan-400 bg-cyan-500/10 border border-cyan-500/20 rounded-full">
                                                    collection
                                                </span>
                                            )}
                                        </div>
                                        <p class="text-xs text-zinc-500 line-clamp-2 mb-3 leading-relaxed">
                                            {target.description || "No description available"}
                                        </p>
                                        <div class="flex items-center justify-between text-[10px]">
                                            <span class={`uppercase tracking-wider font-medium ${style.text}`}>
                                                {target.category}
                                            </span>
                                            <span class="text-zinc-600 font-mono">
                                                {!target.isCompound
                                                    ? target.targets.filter((e) => !e.path.endsWith(".tkape")).length + " paths"
                                                    : target.referencedTargets.length + " targets"}
                                            </span>
                                        </div>
                                    </div>
                                </a>
                            );
                        })}
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .artifact-card {
    will-change: transform, box-shadow;
  }

  .artifact-card:hover {
    transform: translateY(-2px);
  }
</style>

<script define:vars={{ allTargetsJson, scenarioArtifactsJson }}>
  const allTargets = JSON.parse(allTargetsJson);
  const scenarioArtifacts = JSON.parse(scenarioArtifactsJson);

  // Scenario labels for display
  const scenarioLabels = {
    "anti-forensics": "Data Recovery",
    "browser-forensics": "Browser Forensics",
    execution: "Program Execution",
    "lateral-movement": "Lateral Movement",
    persistence: "Persistence",
    "user-activity": "User Activity",
  };

  function updateFilterButtons(activeId) {
    const buttons = document.querySelectorAll(".category-filter-btn");
    buttons.forEach((btn) => {
      const filterId = btn.getAttribute("data-filter-id");
      if (filterId === activeId) {
        btn.setAttribute("data-active", "true");
      } else {
        btn.removeAttribute("data-active");
      }
    });
  }

  function applyFilter() {
    // Parse URL parameters fresh each time
    const params = new URLSearchParams(window.location.search);
    const categoryParam = params.get("category");
    const filterParam = params.get("filter");
    const scenarioParam = params.get("scenario");

    // Query DOM elements fresh each time (for view transitions)
    const filterBanner = document.querySelector("#filter-banner");
    const filterLabel = document.querySelector("#filter-label");
    const filterCount = document.querySelector("#filter-count");
    const defaultView = document.querySelector("#default-view");
    const filteredView = document.querySelector("#filtered-view");
    const filteredCards = document.querySelectorAll(".filtered-card");

    // Determine which filter is active and update buttons
    const activeFilterId = categoryParam || filterParam || "all";
    updateFilterButtons(activeFilterId);

    const matchingSlugs = new Set();
    let label = "";
    let isFiltered = false;

    if (categoryParam) {
      // Category filter via ?category= param
      isFiltered = true;
      label = categoryParam.charAt(0).toUpperCase() + categoryParam.slice(1);
      allTargets.forEach((t) => {
        if (t.category.toLowerCase() === categoryParam.toLowerCase()) {
          matchingSlugs.add(t.slug.toLowerCase());
        }
      });
    } else if (filterParam) {
      isFiltered = true;
      label = filterParam.charAt(0).toUpperCase() + filterParam.slice(1);
      allTargets.forEach((t) => {
        if (t.category.toLowerCase() === filterParam.toLowerCase()) {
          matchingSlugs.add(t.slug.toLowerCase());
        }
      });
    } else if (scenarioParam && scenarioArtifacts[scenarioParam]) {
      isFiltered = true;
      label = scenarioLabels[scenarioParam] || scenarioParam;
      const patterns = scenarioArtifacts[scenarioParam];
      allTargets.forEach((t) => {
        const slugLower = t.slug.toLowerCase();
        if (patterns.some((p) => slugLower.includes(p.toLowerCase()))) {
          matchingSlugs.add(slugLower);
        }
      });
    }

    if (
      filterBanner &&
      filterLabel &&
      filterCount &&
      defaultView &&
      filteredView
    ) {
      if (isFiltered) {
        // Show filter banner
        filterBanner.classList.remove("hidden");
        filterLabel.textContent = label;
        filterCount.textContent = `(${matchingSlugs.size} artifacts)`;

        // Switch views
        defaultView.classList.add("hidden");
        filteredView.classList.remove("hidden");

        // Filter the cards in filtered view
        filteredCards.forEach((card) => {
          const slug = card.getAttribute("data-slug");
          card.classList.toggle("hidden", !(matchingSlugs.has(slug)));
        });
      } else {
        // No filter - show default view
        filterBanner.classList.add("hidden");
        defaultView.classList.remove("hidden");
        filteredView.classList.add("hidden");
      }
    }
  }

  // Apply filter on initial load and view transitions
  applyFilter();
  document.addEventListener("astro:page-load", applyFilter);
</script>
