# Converter Page Improvements

7 features/fixes ordered from quickest to most complex.

## 1. Fix Service Worker Pyodide Version Mismatch
**Files:** `public/sw.js`

- Line 6: Change `v0.27.7` → `v0.29.0`
- Line 2: Bump cache name to `dfirhub-pyodide-v2` to evict stale entries

## 2. Fix Loading Overlay Bottom Padding
**Files:** `src/components/converter/LoadingOverlay.tsx`

- Line 17: Change `absolute inset-0 z-10` → `fixed inset-0 z-50`
- This covers the full viewport including footer during Pyodide loading

## 3. Better Output Syntax Highlighting
**Files:** `src/components/converter/OutputPanel.tsx`

Update `shikiLangMap` with closer Shiki grammar matches:
- `splunk` → `kusto` (pipe-based syntax)
- `esql` → `sql` (SQL-derived)
- `eql` → `python` (expression syntax)
- `kql` → `kusto` (KQL is Kusto)
- `logql` → `kusto` (pipe-based)
- `yara-l` → `javascript` (rule/condition structure)
- `crowdstrike` → `kusto` (pipe-based)
- `sentinelone` → `sql` (PowerQuery is SQL-like)
- `surrealql` → `sql` (SQL-derived)
- Others remain `text` (no close match)

## 4. Drag-and-Drop File Import
**Files:** `src/components/converter/SigmaEditor.tsx`

- Add `isDragging` state and `dragCounter` ref
- Add `onDragEnter`, `onDragLeave`, `onDragOver`, `onDrop` handlers to root div
- Accept `.yml`/`.yaml` files, read with FileReader, call `onChange`
- Show a dashed-border overlay with "Drop .yml file here" when dragging

## 5. Shareable URLs
**Files:** `src/components/converter/ConverterLayout.tsx`, new `src/lib/sigma/share.ts`  
**New deps:** `lz-string`

- New `share.ts` utility: `encodeShareState()` / `decodeShareState()` using lz-string compression
- On mount in ConverterLayout, parse `window.location.hash` for `#s=<encoded>` and restore state (rule, backend, pipeline)
- Add "Share" button (Link icon) in toolbar actions group that generates URL and copies to clipboard
- Show brief "Copied!" feedback

## 6. Sigma YAML Validation
**Files:** `src/components/converter/SigmaEditor.tsx`, new `src/lib/sigma/validate.ts`

New `validate.ts`:
- Parse YAML with js-yaml, catch syntax errors with line info
- Check required fields: `title`, `logsource`, `detection`
- Check recommended fields: `description`, `status`, `level` (warnings)
- Validate `detection.condition` exists
- Validate `status`/`level` enum values
- Return diagnostics with line positions

In SigmaEditor:
- Store `monaco` and `editor` refs
- Run validation on content change (300ms debounce)
- Set Monaco markers via `monaco.editor.setModelMarkers()`

## 7. Filter & Backend Options UI
**Files:** `src/lib/sigma/sigma-converter.ts`, `src/components/converter/ConverterLayout.tsx`, new `src/components/converter/AdvancedOptions.tsx`

- Thread `filterYml`, `correlationMethod`, `backendOptions` through `convert()` and `convertMulti()` signatures
- New state in ConverterLayout: `filterYml`, `correlationMethod`, `backendOptions`, `showAdvanced`
- Persist in localStorage settings
- New `AdvancedOptions.tsx` component with:
  - Filter YAML textarea
  - Correlation method select (default / multisearch)
  - Backend options as dynamic key-value rows with add/remove
- Add "Advanced" toggle button (Settings2 icon) in toolbar

## Verification
- **SW fix:** DevTools > Application > Cache Storage shows v0.29.0 URLs
- **Overlay:** Full viewport coverage during loading, clean dismiss
- **Highlighting:** Convert to each backend, verify colored output
- **Drag-drop:** Drag .yml onto editor loads content; non-.yml ignored
- **Share:** Click Share, paste URL in new tab, verify state restores
- **Validation:** Missing fields show markers, YAML errors show inline, markers clear on fix
- **Advanced:** Filter/options pass through to worker, state persists on reload
