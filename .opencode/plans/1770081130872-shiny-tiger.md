# Plan: useEffect & Hydration Audit Fixes

## Summary
Full-project audit found 1 confirmed hydration bug, 2 missing async cancellation guards, 5 leaking setTimeout handlers, and several low-priority optimizations. No useEffect abuse found — all 20 instances are legitimate.

---

## Phase 1: High Priority (Real Bugs)

### 1A. Create `useCopyFeedback` hook
**New file:** `src/hooks/useCopyFeedback.ts`
- `useCopyFeedback(duration?)` — boolean copied state with auto-cleanup timeout
- `useCopyFeedbackKeyed<T>(duration?)` — keyed variant for CommandGenerator/PathBrowser
- Both clean up timeouts on unmount via useRef + useEffect cleanup

### 1B. Fix hydration mismatch in Search.tsx
**File:** `src/components/search/Search.tsx:209-211`
- **Bug:** `navigator.platform` read during render → server="ctrl", Mac client="⌘"
- **Fix:** Move to `useState(false)` + `useEffect` to detect after hydration

### 1C. Fix missing cancellation in ConverterLayout initialization
**File:** `src/components/converter/ConverterLayout.tsx:185-195`
- **Bug:** `.initialize().then()` has no cancelled flag — state updates fire after unmount
- **Fix:** Add `let cancelled = false` pattern (matches CodeBlock/OutputPanel/useSigmaSearch)

### 1D. Fix missing cancellation in handleConvert
**File:** `src/components/converter/ConverterLayout.tsx:209-259`
- **Bug:** Async conversion sets state without checking mounted status
- **Fix:** Add `mountedRef` and guard all post-await setState calls

---

## Phase 2: Adopt `useCopyFeedback` hook (5 sites)

Replace `setCopied(true); setTimeout(() => setCopied(false), 2000)` with hook:

| File | Pattern |
|------|---------|
| `ConverterLayout.tsx:281` (shareCopied) | `useCopyFeedback()` |
| `OutputPanel.tsx:40-47` (copied) | `useCopyFeedback()` |
| `ScriptBuilder.tsx:109,442` (copied) | `useCopyFeedback()` |
| `CommandGenerator.tsx:23,374` (copiedId) | `useCopyFeedbackKeyed<string>()` |
| `PathBrowser.tsx:10,37-46` (copiedPath) | `useCopyFeedbackKeyed<string>()` |

---

## Phase 3: Low Priority Optimizations

### 3A. Typewriter state → refs in AnimatedSearch
**File:** `src/components/search/AnimatedSearch.tsx:51,53`
- `isTyping` and `currentExample` never rendered in JSX, only drive the effect
- Convert to refs, restructure effect to manage full lifecycle internally

### 3B. Hoist inline framer-motion variants
**Files:** `AnimatedSearch.tsx:318-344`, `InlineSearch.tsx:388-415`
- Extract `containerVariants` and `itemVariants` to module-level constants

### 3C. Hoist Monaco editor options
**File:** `SigmaEditor.tsx:171-182`
- Extract `options` object to module-level `EDITOR_OPTIONS` constant

### 3D. Extract inline callbacks in ConverterLayout
**File:** `ConverterLayout.tsx:539,547`
- `onClose={() => setShowExport(false)}` → `handleExportClose` useCallback
- `onSelect={(yaml) => {...}}` → `handleSigmaSelect` useCallback

---

## Verification

After each phase:
1. `bun build` — must complete with no new errors
2. `npx tsc --noEmit` — no new TS errors (9 pre-existing are expected)
3. Manual checks:
   - Homepage: search typewriter animation works, category pills render
   - Converter: loads Pyodide, converts rules, copy/share/export all work
   - Artifact pages: copy path buttons show feedback for 2s
   - Search: keyboard hint shows ⌘ on Mac (no hydration flash)

## Files Modified
- **New:** `src/hooks/useCopyFeedback.ts`
- **Modified:** `Search.tsx`, `ConverterLayout.tsx`, `OutputPanel.tsx`, `ScriptBuilder.tsx`, `CommandGenerator.tsx`, `PathBrowser.tsx`, `AnimatedSearch.tsx`, `InlineSearch.tsx`, `SigmaEditor.tsx`
